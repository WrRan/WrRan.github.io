<!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="baidu-site-verification" content="1SzRDU50sB"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css"><meta name="keywords" content="blocks,theano,"><link rel="alternate" href="/atom.xml" title="WrRan の 杂货铺" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2"><meta name="description" content="Blocks is a framework that helps you build and manage neural network models on using Theano."><meta name="keywords" content="blocks,theano"><meta property="og:type" content="article"><meta property="og:title" content="Blocks学习手册（八） - 定制Bricks"><meta property="og:url" content="http://www.wrran.com/blog/2017/03/27/howto/blocks/7-create-your-own-brick/index.html"><meta property="og:site_name" content="WrRan の 杂货铺"><meta property="og:description" content="Blocks is a framework that helps you build and manage neural network models on using Theano."><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2019-08-15T19:59:16.494Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Blocks学习手册（八） - 定制Bricks"><meta name="twitter:description" content="Blocks is a framework that helps you build and manage neural network models on using Theano."><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",sidebar:{position:"left",display:"post",offset:12,offset_float:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.wrran.com/blog/2017/03/27/howto/blocks/7-create-your-own-brick/"><title>Blocks学习手册（八） - 定制Bricks | WrRan の 杂货铺</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6d4f6172d2d7b5703b9c1560a5af22a5";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">WrRan の 杂货铺</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description"></h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.wrran.com/blog/2017/03/27/howto/blocks/7-create-your-own-brick/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="WrRan"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="WrRan の 杂货铺"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Blocks学习手册（八） - 定制Bricks</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-27T17:25:39+08:00">2017-03-27 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/howto/" itemprop="url" rel="index"><span itemprop="name">howto</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/howto/theano/" itemprop="url" rel="index"><span itemprop="name">theano</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/howto/theano/blocks/" itemprop="url" rel="index"><span itemprop="name">blocks</span> </a></span></span><span class="post-meta-divider">|</span> <span class="page-pv"><i class="fa fa-file-o"></i> <span class="busuanzi-value" id="busuanzi_value_page_pv"></span> </span><span class="post-meta-divider">|</span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span title="字数统计">2,483</span></div></div></header><div class="post-body han-init-context" itemprop="articleBody"><blockquote><p><code>Blocks</code> is a framework that helps you build and manage neural network models on using Theano.</p></blockquote><a id="more"></a><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>该部分就是来解释下我们该如何自定义bricks的，这可以用来封装一些常用的操作（这些操作也可以是bricks），以便之后复用。</p><p>下述第一部分用来解释自定义bricks的必需和非必需的一些操作；第二部分则自定义一个简单的bricks。</p><p><em>注意</em>：该教程假设读者已经熟悉<em>bricks</em>这个概念并且能够熟练使用。</p><h1 id="自定义bricks需要的条件"><a href="#自定义bricks需要的条件" class="headerlink" title="自定义bricks需要的条件"></a>自定义bricks需要的条件</h1><p>在<em>Blocks</em>中的bricks要么直接要么间接地继承于<code>Brick</code>。<em>Blocks</em>已经定义了不少类，所以在自己定制前选择合适的brick可以省下不少精力。</p><p>下列是一些常用的brick类：</p><ul><li><code>Sequence</code>: a sequence of bricks</li><li><code>Initializable</code>: a brick that defines a same initialization scheme (weights and biases) for all its children</li><li><code>Feedforward</code>: declares an interface for bricks with one input and one output</li><li><code>Linear</code>: a linear transformation with optional bias. Inherits from <code>Initializable</code> and <code>Feedforward</code></li><li><code>BaseRecurrent</code>: the base class for recurrent bricks.</li></ul><p>倘若你想从头开始自定义一个brick，你需要集成类<code>Brick</code>并考虑复写以下方法（严格来说，这些方法都是可选的，实际定义过程中记得参考<code>Brick</code>的内部文档）：</p><ul><li><code>Brick.__init__()</code>: you should pass by argument the attributes of your brick. It is also in this method you should create the protential <em>children bricks</em> that belongs to your brick (in that case, you have to pass the children bricks to <code>super().__init__</code>). The initialization of the attributes can be lazy as described later in the tutorial.</li><li><code>apply()</code>: you need to implement a method that actually implements the operation of the brick, taking as arguments the inputs of the brick and returing its outputs. It can have any name and for simple bricks is often named <code>apply</code>. You should decorate it with the <code>application()</code> decorator, as explained in the next section. If you design a recurrent brick, you should decorate it with the <code>recurrent()</code> decorator as explained in the <a href="http://localhost:8080/blog/2017/03/27/howto-blocks-5-recurrent-neural-networks/" target="_blank" rel="noopener">blogs about rnns</a>.</li><li><code>Brick._allocate()</code>: you should implement this method to allocate the shared variables (often representing parameters) of the bricks. In Blocks, by convention, the built-in bricks allocate their shared variables with nan values and we recommend you to do the same.</li><li><code>Brick._initialize()</code>: you should implement this method to initialize the shared variables of your brick. This method is called after the allocation.</li><li><code>Brick._push_allocation_config()</code>: you should consider overwriting this method if you want to change configuration of the children bricks before they allocate their parameters.</li><li><code>Brick._push_initialization_config()</code>: you should consider overwriting this method if you want to change the initialization schemes of the children before they get initialied. If the children bricks need to be initialized with the same scheme, then you should inherit your brick from <code>Initializable</code>, which automatically pushes the initialization schemes of your brick (provided as arguments <code>weights_init</code> and <code>biases_init</code> of the constructor) to the children bricks.</li><li><code>get_dim()</code>: implementing this function is useful if you want to provide a simple way to get the dimensions of the inputs and outputs of the bricks.</li></ul><p>如果从其他类型的brick继承的话，也要记得查看对应类的文档，确定要复写哪些方法/属性。</p><h2 id="方法application"><a href="#方法application" class="headerlink" title="方法application"></a>方法application</h2><p>上述方法中，<code>apply()</code>可以说是最为重要的一者。因为它完成了读入theano variable，并处理输出的工作。我们应当记住用<code>application()</code>来装饰该方法，它会帮我们命名变量并创建一些辅助变量。好比如说这样：</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(Brick)</span>:</span></span><br><span class="line"><span class="meta">    @application(</span></span><br><span class="line">        inputs=[<span class="string">'input1'</span>, <span class="string">'input2'</span>],</span><br><span class="line">        outputs=[<span class="string">'output'</span>]</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span><span class="params">(self, input1, input2)</span>:</span></span><br><span class="line">        y = input1 + input2</span><br><span class="line">        <span class="keyword">return</span> y</span><br></pre></td></tr></table></figure><p>如上例所示，如此做后它将自动将theano tensor variable<code>input1</code>重命名为<code>Foo_apply_input1</code>，<code>input2</code>重命名为<code>Foo_apply_input2</code>，并将该方法的输出命名为<code>foo_apply_output</code>。并且它也会将对应的角色与名字赋值给该变量的<code>tag</code>属性。如下：</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">foo = Foo()</span><br><span class="line">i1 = tensor.matrix(<span class="string">'i1'</span>)</span><br><span class="line">i2 = tensor.matrix(<span class="string">'i2'</span>)</span><br><span class="line">y = foo.apply(x)</span><br><span class="line">theano.printing.debugprint(y)</span><br><span class="line"><span class="comment"># Elemwise&#123;identity&#125; [id A] 'foo_apply_output'</span></span><br><span class="line"><span class="comment">#  |Elemwise&#123;add,no_inplace&#125; [id B] ''</span></span><br><span class="line"><span class="comment">#    |Elemwise&#123;identity&#125; [id C] 'foo_apply_input1'</span></span><br><span class="line"><span class="comment">#    | |i1 [id D]</span></span><br><span class="line"><span class="comment">#    |Elemwise&#123;identity&#125; [id E] 'foo_apply_input2'</span></span><br><span class="line"><span class="comment">#      |i2 [id F]</span></span><br><span class="line">print(y.name)</span><br><span class="line"><span class="comment"># foo_apply_output</span></span><br><span class="line">print(y.tag.name)</span><br><span class="line"><span class="comment"># output</span></span><br><span class="line">print(y.tag.roles)</span><br><span class="line"><span class="comment"># [OUTPUT]</span></span><br></pre></td></tr></table></figure><p>其实，装饰器<code>@application</code>实际创建了一个类型为<code>Application</code>的类，并命名为<code>apply</code>，并赋值给了brick的一个属性：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(type(Foo.apply))</span><br></pre></td></tr></table></figure><p></p><h2 id="application-properties"><a href="#application-properties" class="headerlink" title="application properties"></a>application properties</h2><p>在前面的示例中，我们通过<code>@application</code>这个装饰器直接指定了参数的名称。我们也可以通过其他方式指定参数名称，例如下例中通过使用装饰器<code>apply.property</code>指定参数名称为<code>self.fancy_name</code>:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(Brick)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fancy_name)</span>:</span></span><br><span class="line">        self.fancy_name = fancy_name</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @application</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span><span class="params">(self, input)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @apply.property('inputs')</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply_inputs</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># Note that you can use any python code to define the name</span></span><br><span class="line">        <span class="keyword">return</span> self.fancy_name</span><br></pre></td></tr></table></figure><h2 id="using-application-calls"><a href="#using-application-calls" class="headerlink" title="using application calls"></a>using application calls</h2><p>在某些场景下你可能希望在<code>apply</code>中定义某些辅助变量，以方便后面使用，如定义一些辅助量来监测训练过程。为此，你只需要将<code>application_call</code>作为<code>apply</code>的参数，并使用<code>add_auxiliary_variable</code>注册你需要的变量：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(Brick)</span>:</span></span><br><span class="line"><span class="meta">    @application</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span><span class="params">(self, x, application_call)</span>:</span></span><br><span class="line">        application_call.add_auxiliary_variable(</span><br><span class="line">            x.mean()</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> x + <span class="number">1</span></span><br></pre></td></tr></table></figure><p></p><p><code>add_auxiliary_variable</code>将注解变量<code>x.mean()</code>为辅助bain两，因此你可以通过<code>ComputationGraph</code>取出该辅助变量，并使用<code>VariableFilter</code>进行过滤。如上例中，我们可以通过如下方式取出<code>x.mean()</code>:<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bricks.graph <span class="keyword">import</span> ComputationGraph</span><br><span class="line">x = tensor.fmatrix(<span class="string">'x'</span>)</span><br><span class="line">y = Foo().apply(x)</span><br><span class="line">cg = ComputationGraph(y)</span><br><span class="line">print(cg.auxiliary_variable)</span><br><span class="line"><span class="comment"># [mean]</span></span><br></pre></td></tr></table></figure><p></p><h2 id="lazy-initialization"><a href="#lazy-initialization" class="headerlink" title="lazy initialization"></a>lazy initialization</h2><p>为了防止强迫用户在创建brick时就要指定所有属性，我们可以通过用<code>@lazy</code>注解<code>__init__</code>方法。来让用户可以在创建brick之后，再设定属性：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@lazy(</span></span><br><span class="line">    allocation=[<span class="string">'attr1'</span>, <span class="string">'attr2'</span>]</span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, attr1, attr2)</span>:</span></span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure><p></p><p>上例中，就允许用户在创建了brick之后，在指定属性<code>attr1</code>与<code>attr2</code>。</p><p>再举个例子，我们创建一个由两个<code>Feedforward</code>组成的<code>ChainOfTwoFeedforward</code>。我们不必在创建该类时就指定<code>bricks</code>的属性<code>input_dim</code>：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChainOfTwoFeedforward</span><span class="params">(Feedforward)</span>:</span></span><br><span class="line">    <span class="string">"""Two sequential Feedforward bricks."""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, brick1, brick2, **kwargs)</span>:</span></span><br><span class="line">        self.brick1 = brick1</span><br><span class="line">        self.brick2 = brick2</span><br><span class="line">        children = [self.brick1, self.brick2]</span><br><span class="line">        kwargs.setdefaults(<span class="string">'children'</span>, []).extend(children)</span><br><span class="line">        super(Feedforward, self).__init__(**kwargs)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">input_dim</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.brick1.input_dim</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @input_dim.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">input_dim</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self.brick1.input_dim = value</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">output_dim</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.brick2.output_dim</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @output_dim.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">output_dim</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self.brick2.output_dim = value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_push_allocation_config</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.brick2.input_dim = self.brick1.get_dim(<span class="string">'output'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @application</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.brick2.apply(</span><br><span class="line">            self.brick1.apply(x)</span><br><span class="line">        )</span><br></pre></td></tr></table></figure><p></p><p>之后我们就可以如下例使用<code>ChainOfTwoFeedforward</code>：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">brick1 = Linear(</span><br><span class="line">    input_dim=<span class="number">3</span>, output_dim=<span class="number">2</span>, use_bias=<span class="literal">False</span>,</span><br><span class="line">    weights_init=Constant(<span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line">brick2 = Linear(</span><br><span class="line">    output_dim=<span class="number">4</span>, use_bias=<span class="literal">False</span>,</span><br><span class="line">    weights_init=Constant(<span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line">seq = ChainOfTwoFeedforward(brick1, brick2)</span><br><span class="line">seq.initialize()</span><br><span class="line">brick2.input_dim</span><br><span class="line"><span class="comment"># 2</span></span><br></pre></td></tr></table></figure><p></p><h1 id="自定义bricks的示例"><a href="#自定义bricks的示例" class="headerlink" title="自定义bricks的示例"></a>自定义bricks的示例</h1><p>为了巩固上面提到的知识点，我们假设一个场景：需要我们分别读取两个batch的输入，分别乘上不同的矩阵后，输出两个输出。</p><p>设计brick的第一步是考虑该选用哪一个brick。很明显我们这儿实现的是<code>Linear</code>的变种。与<code>Linear</code>不同的是，此处我们有两个输入和两个输出。这意味着我们不能不能从要求只有一个输入、一个输出<code>Feedforward</code>继承而来。我们的brick需要用两个不同的矩阵。我们想用同样的方式初始化这两个矩阵时，可以继承<code>Initializable</code>。它将自动将parent brick的初始化模式复制给children bricks。初始化模式可以由构造函数的参数<code>weights_init</code>与<code>biases_init</code>指出（包含在参数<code>kwargs</code>中）。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParallelLinear</span><span class="params">(Initializable)</span>:</span></span><br><span class="line">    <span class="string">r""" Two linear transformations without biases.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Brick which applies two linear (affine) transformations by</span></span><br><span class="line"><span class="string">    multiplying its two inputs with two weight matries, resulting in</span></span><br><span class="line"><span class="string">    two outputs.</span></span><br><span class="line"><span class="string">    The two inputs, weights and outputs can have different dimensions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    input_dim&#123;1, 2&#125; : int</span></span><br><span class="line"><span class="string">        The dimensions of the two inputs.</span></span><br><span class="line"><span class="string">    output_dim&#123;1, 2&#125;: int</span></span><br><span class="line"><span class="string">        The dimensions of the two outputs.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"><span class="meta">    @lazy(</span></span><br><span class="line">        allocation=[</span><br><span class="line">            <span class="string">'input_dim1'</span>, <span class="string">'input_dim2'</span>,</span><br><span class="line">            <span class="string">'output_dim1'</span>, <span class="string">'output_dim2'</span></span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(ParallelLinear, self).__init__(**kwargs)</span><br><span class="line">         self.input_dim1 = input_dim1</span><br><span class="line">         self.input_dim2 = input_dim2</span><br><span class="line">         self.output_dim1 = output_dim1</span><br><span class="line">         self.output_dim2 = output_dim2</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__allocate</span><span class="params">(self, input_dim, output_dim, number)</span>:</span></span><br><span class="line">        W = shared_floatx_nans(</span><br><span class="line">            (input_dim, output_dim),</span><br><span class="line">            name=<span class="string">'W'</span>+number</span><br><span class="line">        )</span><br><span class="line">        add_role(W, WEIGHT)</span><br><span class="line">        self.parameter.append(W)</span><br><span class="line">        self.add_auxiliary_variable(W.norm(<span class="number">2</span>), name=<span class="string">'W'</span>+number+<span class="string">'_norm'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_allocate</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.__allocate(self.input_dim1, self.output_dim1, <span class="string">'1'</span>)</span><br><span class="line">        self.__allocate(self.input_dim2, self.output_dim2, <span class="string">'2'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_initialize</span><span class="params">(self)</span>:</span></span><br><span class="line">        W1, W2 = self.parameters</span><br><span class="line">        self.weights_init.initialize(W1, self.rng)</span><br><span class="line">        self.weights_init.initialize(W2, self.rng)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span><span class="params">(self, input1_, input2_)</span>:</span></span><br><span class="line">        <span class="string">""" Apply the two linear transformations.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        input1&#123;1, 2&#125;_: :class:`~tensor.TensorVariable`</span></span><br><span class="line"><span class="string">            The two inputs on which to apply the transformations.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns</span></span><br><span class="line"><span class="string">        -------</span></span><br><span class="line"><span class="string">        output&#123;1, 2&#125;: :class:`~tensor.TensorVariable`</span></span><br><span class="line"><span class="string">            The two inputs multiplied by their respective matrices.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        W1, W2 = self.parameters</span><br><span class="line">        output1 = tensor.dot(input1_, W1)</span><br><span class="line">        output2 = tensor.dot(input2_, W2)</span><br><span class="line">        <span class="keyword">return</span> output1, output2</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_dim</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'input1_'</span>:</span><br><span class="line">            <span class="keyword">return</span> self.input_dim1</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'input2_'</span>:</span><br><span class="line">            <span class="keyword">return</span> self.input_dim2</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'output1'</span>:</span><br><span class="line">            <span class="keyword">return</span> self.output_dim1</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'output2'</span>:</span><br><span class="line">            <span class="keyword">return</span> self.output_dim2</span><br><span class="line">        super(ParallelLinear, self).get_dim(name)</span><br></pre></td></tr></table></figure><p>你可以如下使用上述定义的brick：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">input_dim1, input_dim2, output_dim1, output_dim2 = <span class="number">10</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span></span><br><span class="line">batch_size1, batch_size2 = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line"></span><br><span class="line">x1_mat = <span class="number">3</span> * numpy.ones(</span><br><span class="line">    (batch_size1, input_dim1),</span><br><span class="line">    dtype=theano.config.floatX</span><br><span class="line">)</span><br><span class="line">x2_dim = <span class="number">4</span> * numpy.ones(</span><br><span class="line">    (batch_size2, input_dim2),</span><br><span class="line">    dtype=theano.config.floatX</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">x1 = theano.tensor.matrix(<span class="string">'x1'</span>)</span><br><span class="line">x2 = theano.tensor.matrix(<span class="string">'x2'</span>)</span><br><span class="line"></span><br><span class="line">parallel1 = ParallelLinear(</span><br><span class="line">    input_dim1, input_dim2, output_dim1, output_dim2,</span><br><span class="line">    weights_init=Constant(<span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line">parallel1.initialize()</span><br><span class="line">output1, output2 = parallel1.apply(x1, x2)</span><br><span class="line"></span><br><span class="line">f1 = theano.function([x1, x2], [output1, output2])</span><br><span class="line"></span><br><span class="line">f1(x1_mat, x2_mat)</span><br></pre></td></tr></table></figure><p></p><p>你也可以使用<code>Linear</code>来实现该brick：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParallelLinear2</span><span class="params">(Initializable)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, input_dim1, input_dim2,</span></span></span><br><span class="line"><span class="function"><span class="params">                 output_dim1, output_dim2,</span></span></span><br><span class="line"><span class="function"><span class="params">                 **kwargs)</span>:</span></span><br><span class="line">        self.linear1 = Linear(input_dim1, output_dim1,</span><br><span class="line">                              use_bias=<span class="literal">False</span>, **kwargs)</span><br><span class="line">        self.linear2 = Linear(input_dim2, output_dim2,</span><br><span class="line">                              use_bias=<span class="literal">False</span>, **kwargs)</span><br><span class="line">        children = [self.linear1, self.linear2]</span><br><span class="line">        kwargs.setdefault(<span class="string">'children'</span>, []).extend(children)</span><br><span class="line">        super(ParallelLinear2, self).__init__(**kwargs)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @application(</span></span><br><span class="line">        inputs=[<span class="string">'input1_'</span>, <span class="string">'input2_'</span>],</span><br><span class="line">        outputs=[<span class="string">'output1'</span>, <span class="string">'output2'</span>]</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span><span class="params">(self, input1_, input2_)</span>:</span></span><br><span class="line">        output1 = self.linear1.apply(input1_)</span><br><span class="line">        output2 = self.linear2.apply(input2_)</span><br><span class="line">        <span class="keyword">return</span> output1, output2</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_dim</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> [<span class="string">'input1_'</span>, <span class="string">'output1'</span>]:</span><br><span class="line">            <span class="keyword">return</span> self.linear1.get_dim(name)</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> [<span class="string">'input2_'</span>, <span class="string">'output2'</span>]:</span><br><span class="line">            <span class="keyword">return</span> self.linear2.get_dim(name)</span><br><span class="line">        super(ParallelLinear2, self).get_dim(name)</span><br></pre></td></tr></table></figure><p></p><p>这个版本则可以如下使用：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">parallel2 = ParallelLinear2(</span><br><span class="line">    input_dim1, input_dim2, </span><br><span class="line">    output_dim1, output_dim2,</span><br><span class="line">    weights_init=Constant(<span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line">parallel2.initialize()</span><br><span class="line"><span class="comment"># The weights_init initialization scheme is pushed to the children</span></span><br><span class="line"><span class="comment"># bricks. We can verify it as follow:</span></span><br><span class="line">w = parallel2.weights_init</span><br><span class="line">w0 = parallel2.children[<span class="number">0</span>].weights_init</span><br><span class="line">w1 = parallel2.children[<span class="number">1</span>].weights_init</span><br><span class="line">print(w == w0 == w1)</span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"></span><br><span class="line">output1, output2 = parallel2.apply(x1, x2)</span><br><span class="line"></span><br><span class="line">f2 = theano.function([x1, x2], [output1, output2])</span><br><span class="line">f2(x1_mat, x2_mat)</span><br></pre></td></tr></table></figure><p></p><p>实际我们完全没有必要因为上述的需求自己写一个brick，因为<em>Blocks</em>提供了类<code>Parallel</code>(which applies the same prototype brick to several inputs.)：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">parallel3 = Parallel(</span><br><span class="line">    prototype=Linear(use_bias=<span class="literal">False</span>),</span><br><span class="line">    input_names=[<span class="string">'input1_'</span>, <span class="string">'input2_'</span>],</span><br><span class="line">    input_dims=[input_dim1, input_dim2],</span><br><span class="line">    output_dims=[output_dim1, output_dim2],</span><br><span class="line">    weights_init=Constant(<span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line">parallel3.initialize()</span><br><span class="line"></span><br><span class="line">output1, output2 = parallel3.apply(x1, x2)</span><br><span class="line">f3(x1_mat, x2_mat)</span><br></pre></td></tr></table></figure><p></p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://blocks.readthedocs.io/en/latest/create_your_own_brick.html" target="_blank" rel="noopener">Blocks’ doc - Create Your Own Brick</a></p></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> WrRan</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://www.wrran.com/blog/2017/03/27/howto/blocks/7-create-your-own-brick/" title="Blocks学习手册（八） - 定制Bricks">http://www.wrran.com/blog/2017/03/27/howto/blocks/7-create-your-own-brick/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/blocks/" rel="tag"># blocks</a> <a href="/tags/theano/" rel="tag"># theano</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/blog/2017/03/27/howto/blocks/6-configuration/" rel="next" title="Blocks学习手册（七） - 配置Blocks"><i class="fa fa-chevron-left"></i> Blocks学习手册（七） - 配置Blocks</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/blog/2017/03/27/howto/blocks/8-serialization/" rel="prev" title="Blocks学习手册（九） - Serialization">Blocks学习手册（九） - Serialization <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zMjQ4OC85MDQ5"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="WrRan"><p class="site-author-name" itemprop="name">WrRan</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">232</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">73</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">114</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/WrRan" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub </a></span><span class="links-of-author-item"><a href="http://xtf615.com/" target="_blank" title="xuetf"><i class="fa fa-fw fa-globe"></i> xuetf</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自定义bricks需要的条件"><span class="nav-number">2.</span> <span class="nav-text">自定义bricks需要的条件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#方法application"><span class="nav-number">2.1.</span> <span class="nav-text">方法application</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#application-properties"><span class="nav-number">2.2.</span> <span class="nav-text">application properties</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#using-application-calls"><span class="nav-number">2.3.</span> <span class="nav-text">using application calls</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lazy-initialization"><span class="nav-number">2.4.</span> <span class="nav-text">lazy initialization</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自定义bricks的示例"><span class="nav-number">3.</span> <span class="nav-text">自定义bricks的示例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">4.</span> <span class="nav-text">参考资料</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 - <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">WrRan</span></div><div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by">Hosted by <a href="https://pages.coding.me" style="font-weight:700">Coding Pages</a></div><div class="theme-info">主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i> <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="site-pv"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><script type="text/javascript">// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>